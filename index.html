<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Life Leveler</title>
    <script>
        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ VK Bridge
        window.vkBridgePromise = new Promise(resolve => {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js';
            script.async = true;
            script.onload = () => resolve(window.vkBridge);
            document.head.appendChild(script);
        });
    </script>
    <style>
        :root {
            --bg-light: #f5f7fa;
            --bg-dark: #19191a;
            --text-light: #333;
            --text-dark: #e1e3e6;
            --box-light: #fff;
            --box-dark: #2c2d2e;
            --primary: #4a76a8;
            --accent: #ff6b6b;
            --success: #4CAF50;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --vk-blue: #5181b8;
            --vk-blue-dark: #45688e;
        }

        /* –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        #app {
            max-width: 550px;
            margin: 0 auto;
            padding: 0 0 80px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .vk-header {
            background: linear-gradient(135deg, var(--vk-blue), var(--vk-blue-dark));
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ */
    </style>
    <link rel="stylesheet" href="data:text/css;base64,LnNwaW5uZXIgewogICAgd2lkdGg6IDYwcHg7CiAgICBoZWlnaHQ6IDYwcHg7CiAgICBib3JkZXI6IDZweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMyk7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBib3JkZXItdG9wOiA2cHggc29saWQgd2hpdGU7CiAgICBhbmltYXRpb246IHNwaW4gMXMgbGluZWFyIGluZmluaXRlOwogICAgbWFyZ2luLWJvdHRvbTogMjVweDsKfQoKQGtleWZyYW1lcyBzcGluIHsKICAgIDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0KICAgIDEwMCUgeyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9Cn0KCi5sb2FkaW5nLXNjcmVlbiB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICB0b3A6IDA7CiAgICBsZWZ0OiAwOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCB2YXIoLS12ay1ibHVlKSwgdmFyKC0tdmstYmx1ZS1kYXJrKSk7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIHotaW5kZXg6IDEwMDAwOwogICAgY29sb3I6IHdoaXRlOwogICAgZm9udC1zaXplOiAxLjJyZW07CiAgICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuNXM7Cn0KCi5hcHAgewogICAgZGlzcGxheTogbm9uZTsKfQoKLmxvYWRpbmctdGV4dCB7CiAgICBtYXJnaW4tdG9wOiAyMHB4OwogICAgZm9udC1zaXplOiAxLjFyZW07CiAgICBvcGFjaXR5OiAwLjk7Cn0=" media="print" onload="this.media='all'">
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
        <div class="loading-text">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
    </div>
    
    <div id="app">
        <div class="vk-header">
            <div class="header">
                <h1 class="app-title">üê± Life Leveler</h1>
                <div class="header-actions">
                    <div class="streak">
                        <span class="streak-icon">üî•</span>
                        <span id="streak-count">0</span>
                    </div>
                    <button class="theme-toggle" id="theme-toggle">üåô</button>
                </div>
            </div>
        </div>
        
        <div class="app-box">
            <form class="todo-form" id="todo-form">
                <input type="text" class="todo-input" id="task-input" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." required autocomplete="off">
                <select class="category-select" id="category-select"></select>
                <button type="submit" class="add-button">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
            
            <div class="productivity-container">
                <div class="productivity-header">
                    <div>–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
                    <div>–°–µ–≥–æ–¥–Ω—è: <span id="completed-today">0</span>/5</div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        <div class="progress-label" id="progress-label">–î–µ–Ω—å: 0/5</div>
                    </div>
                </div>
            </div>
            
            <div class="categories-filter" id="categories-filter"></div>
            
            <div class="todos-container" id="todos-container"></div>
        </div>
        
        <div class="app-footer">
            <div id="summary-text">–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</div>
            <button class="clear-button" id="clear-button">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
    </div>
    
    <div class="assistant-container" id="assistant-container">
        <div class="assistant-message" id="assistant-message" style="display: none;">
            <span class="emoji">üê±</span>
            <span id="assistant-text">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫-–∫–æ—Ç–∏–∫!</span>
        </div>
        <div class="cat-assistant" id="cat-assistant">
            <div class="cat-eyes">
                <div class="cat-eye"></div>
                <div class="cat-eye"></div>
            </div>
            <div class="cat-mouth"></div>
        </div>
    </div>

    <script>
        // 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π JS
        (function() {
            // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            const DAILY_GOAL = 5;
            const CATEGORIES = [
                { id: 'work', name: '–†–∞–±–æ—Ç–∞', color: '#FF6B6B' },
                { id: 'study', name: '–£—á–µ–±–∞', color: '#4ECDC4' },
                { id: 'home', name: '–î–æ–º', color: '#FFD166' },
                { id: 'health', name: '–ó–¥–æ—Ä–æ–≤—å–µ', color: '#06D6A0' },
                { id: 'other', name: '–î—Ä—É–≥–æ–µ', color: '#118AB2' }
            ];

            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            const state = {
                todos: JSON.parse(localStorage.getItem('todos') || '[]'),
                darkMode: localStorage.getItem('darkMode') === 'true',
                currentCategory: localStorage.getItem('currentCategory') || 'all',
                completedToday: parseInt(localStorage.getItem('completedToday') || '0'),
                streak: parseInt(localStorage.getItem('streak') || '0'),
                lastCompletedDate: localStorage.getItem('lastCompletedDate') || new Date().toDateString(),
                vkUser: null
            };

            // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const domCache = {};

            // 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω—ã
            function createTodoElement(todo) {
                const category = CATEGORIES.find(c => c.id === todo.category) || 
                               { id: 'other', name: '–î—Ä—É–≥–æ–µ', color: '#118AB2' };
                
                const todoElement = document.createElement('div');
                todoElement.className = `todo-item ${todo.completed ? 'completed' : ''}`;
                todoElement.innerHTML = `
                    <div class="category-marker" style="background-color: ${category.color}"></div>
                    <div class="todo-content">
                        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''}>
                        <div class="todo-text">${todo.task}</div>
                    </div>
                    <div class="category-label" style="color: ${category.color}">${category.name}</div>
                    <button class="remove-button">√ó</button>
                `;
                todoElement.dataset.id = todo.id;
                return todoElement;
            }

            // 3. –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
            function setupEventDelegation() {
                document.addEventListener('click', e => {
                    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
                    if (e.target.id === 'theme-toggle') {
                        toggleDarkMode();
                        return;
                    }
                    
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
                    if (e.target.closest('#todo-form')) {
                        if (e.target.type === 'submit' || e.target.closest('button[type="submit"]')) {
                            addTask(e);
                        }
                        return;
                    }
                    
                    // –û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö
                    if (e.target.id === 'clear-button') {
                        clearCompleted();
                        return;
                    }
                    
                    // –ö–ª–∏–∫ –ø–æ –∫–æ—Ç–∏–∫—É
                    if (e.target.closest('#cat-assistant')) {
                        showAssistantMessage('welcome');
                        return;
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á
                    const todoItem = e.target.closest('.todo-item');
                    if (!todoItem) return;
                    
                    const id = parseInt(todoItem.dataset.id);
                    
                    // –ß–µ–∫–±–æ–∫—Å
                    if (e.target.classList.contains('todo-checkbox')) {
                        toggleTask(id);
                        return;
                    }
                    
                    // –£–¥–∞–ª–µ–Ω–∏–µ
                    if (e.target.classList.contains('remove-button')) {
                        removeTask(id);
                    }
                });
                
                // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
                document.addEventListener('keydown', e => {
                    if (e.target.id !== 'task-input') return;
                    
                    // Command/Ctrl + Enter
                    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                        addTask(e);
                        return;
                    }
                    
                    // Escape
                    if (e.key === 'Escape') {
                        e.target.value = '';
                    }
                });
            }

            // 4. –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
            function loadNonCriticalStyles() {
                const style = document.createElement('style');
                style.textContent = `
                    body.dark-mode {
                        background-color: var(--bg-dark);
                        color: var(--text-dark);
                    }
                    
                    .dark-mode .app-box {
                        background: var(--box-dark);
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    }
                    
                    .dark-mode .todo-input {
                        border-color: #444;
                    }
                    
                    .dark-mode .category-select {
                        border-color: #444;
                    }
                    
                    .dark-mode .productivity-container {
                        background: rgba(81, 129, 184, 0.15);
                    }
                    
                    .dark-mode .category-button {
                        background: #3a3b3c;
                        color: #e1e3e6;
                    }
                    
                    .dark-mode .todo-item {
                        background: rgba(255, 255, 255, 0.05);
                    }
                    
                    .dark-mode .todo-item:hover {
                        background: rgba(255, 255, 255, 0.08);
                    }
                    
                    .dark-mode .category-label {
                        background: rgba(255, 255, 255, 0.1);
                    }
                    
                    .dark-mode .app-footer {
                        background: var(--box-dark);
                    }
                    
                    .dark-mode .empty-state {
                        color: #999;
                    }
                    
                    .dark-mode .progress-bar {
                        background: #3a3b3c;
                    }
                    
                    .app-box {
                        background: var(--box-light);
                        border-radius: 16px;
                        padding: 20px;
                        box-shadow: var(--shadow);
                        margin: 15px;
                        transition: background-color 0.3s, box-shadow 0.3s;
                        flex-grow: 1;
                    }
                    
                    .todo-form {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 25px;
                        flex-wrap: wrap;
                    }
                    
                    .todo-input {
                        flex: 1;
                        min-width: 200px;
                        padding: 14px 16px;
                        border: 1px solid #ddd;
                        border-radius: 10px;
                        font-size: 1rem;
                        background: transparent;
                        color: inherit;
                        transition: border-color 0.3s;
                        font-family: inherit;
                    }
                    
                    .todo-input:focus {
                        outline: none;
                        border-color: var(--vk-blue);
                        box-shadow: 0 0 0 2px rgba(81, 129, 184, 0.2);
                    }
                    
                    .category-select {
                        padding: 14px 12px;
                        border: 1px solid #ddd;
                        border-radius: 10px;
                        background: transparent;
                        color: inherit;
                        min-width: 120px;
                        cursor: pointer;
                        font-family: inherit;
                    }
                    
                    .add-button {
                        padding: 14px 24px;
                        background: var(--vk-blue);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: background 0.2s, transform 0.1s;
                        font-family: inherit;
                        flex: 1;
                    }
                    
                    .add-button:hover {
                        background: var(--vk-blue-dark);
                    }
                    
                    .add-button:active {
                        transform: scale(0.98);
                    }
                    
                    .productivity-container {
                        background: rgba(81, 129, 184, 0.1);
                        border-radius: 12px;
                        padding: 18px;
                        margin-bottom: 25px;
                    }
                    
                    .productivity-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                        font-weight: 500;
                    }
                    
                    .streak {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-weight: 700;
                        font-size: 1.1rem;
                    }
                    
                    .streak-icon {
                        color: #ff6b00;
                    }
                    
                    .progress-container {
                        margin-top: 15px;
                    }
                    
                    .progress-bar {
                        height: 28px;
                        background: #e0e0e0;
                        border-radius: 14px;
                        overflow: hidden;
                        position: relative;
                    }
                    
                    .progress-fill {
                        height: 100%;
                        background: linear-gradient(90deg, var(--vk-blue), var(--vk-blue-dark));
                        transition: width 0.5s ease;
                    }
                    
                    .progress-label {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 0.95rem;
                        font-weight: 600;
                        color: white;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    }
                    
                    .categories-filter {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                        margin-bottom: 20px;
                    }
                    
                    .category-button {
                        padding: 10px 18px;
                        border: none;
                        border-radius: 24px;
                        background: #f0f0f0;
                        cursor: pointer;
                        font-size: 0.95rem;
                        transition: all 0.2s;
                        font-weight: 500;
                    }
                    
                    .category-button.active {
                        transform: scale(1.05);
                        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
                        font-weight: 600;
                    }
                    
                    .todos-container {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    
                    .todo-item {
                        display: flex;
                        align-items: center;
                        padding: 16px 18px;
                        border-radius: 12px;
                        background: rgba(0, 0, 0, 0.03);
                        transition: all 0.2s;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .todo-item:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                    }
                    
                    .todo-item.completed {
                        opacity: 0.7;
                    }
                    
                    .category-marker {
                        position: absolute;
                        left: 0;
                        top: 0;
                        bottom: 0;
                        width: 8px;
                        border-radius: 8px 0 0 8px;
                    }
                    
                    .todo-content {
                        display: flex;
                        align-items: center;
                        flex-grow: 1;
                        gap: 14px;
                    }
                    
                    .todo-checkbox {
                        width: 22px;
                        height: 22px;
                        cursor: pointer;
                        accent-color: var(--vk-blue);
                    }
                    
                    .todo-text {
                        flex-grow: 1;
                        word-break: break-word;
                        font-size: 1.05rem;
                    }
                    
                    .todo-item.completed .todo-text {
                        text-decoration: line-through;
                    }
                    
                    .category-label {
                        padding: 5px 12px;
                        border-radius: 14px;
                        font-size: 0.85rem;
                        background: rgba(0, 0, 0, 0.08);
                        white-space: nowrap;
                        font-weight: 500;
                    }
                    
                    .remove-button {
                        background: none;
                        border: none;
                        font-size: 1.6rem;
                        cursor: pointer;
                        opacity: 0.5;
                        transition: opacity 0.2s;
                        width: 36px;
                        height: 36px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        color: inherit;
                    }
                    
                    .remove-button:hover {
                        opacity: 1;
                        background: rgba(255, 0, 0, 0.1);
                    }
                    
                    .app-footer {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 18px 20px;
                        font-size: 1rem;
                        background: var(--box-light);
                        margin: 0 15px;
                        border-radius: 16px;
                        box-shadow: var(--shadow);
                    }
                    
                    .clear-button {
                        background: var(--accent);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                        transition: background 0.2s;
                        font-family: inherit;
                        font-size: 0.95rem;
                    }
                    
                    .clear-button:hover {
                        background: #e55a5a;
                    }
                    
                    .assistant-container {
                        position: fixed;
                        bottom: 25px;
                        right: 25px;
                        z-index: 1000;
                        display: flex;
                        flex-direction: column;
                        align-items: flex-end;
                        gap: 15px;
                    }
                    
                    .assistant-message {
                        background-color: var(--vk-blue);
                        color: white;
                        padding: 14px 20px;
                        border-radius: 20px;
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                        max-width: 280px;
                        animation: fadeIn 0.4s ease-out;
                        position: relative;
                        font-size: 1rem;
                        line-height: 1.4;
                    }
                    
                    .assistant-message::after {
                        content: '';
                        position: absolute;
                        bottom: -10px;
                        right: 20px;
                        border-width: 10px 10px 0;
                        border-style: solid;
                        border-color: var(--vk-blue) transparent transparent;
                    }
                    
                    .emoji {
                        margin-right: 8px;
                        font-size: 1.2em;
                    }
                    
                    .cat-assistant {
                        width: 85px;
                        height: 85px;
                        background: linear-gradient(135deg, #ffd166, #ffb347);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 55px;
                        cursor: pointer;
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                        transition: transform 0.3s, background 0.3s;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .cat-assistant:hover {
                        transform: scale(1.08);
                    }
                    
                    .cat-assistant.celebrating {
                        animation: celebrate 0.8s ease infinite;
                    }
                    
                    .cat-assistant.sleeping {
                        animation: sleeping 4s ease infinite;
                    }
                    
                    .cat-eyes {
                        position: absolute;
                        top: 32%;
                        display: flex;
                        gap: 18px;
                    }
                    
                    .cat-eye {
                        width: 10px;
                        height: 14px;
                        background: #333;
                        border-radius: 50%;
                    }
                    
                    .cat-mouth {
                        position: absolute;
                        top: 55%;
                        width: 24px;
                        height: 10px;
                        background: #333;
                        border-radius: 0 0 12px 12px;
                    }
                    
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    
                    @keyframes celebrate {
                        0%, 100% { transform: translateY(0) rotate(0); }
                        25% { transform: translateY(-12px) rotate(-8deg); }
                        50% { transform: translateY(0) rotate(0); }
                        75% { transform: translateY(-12px) rotate(8deg); }
                    }
                    
                    @keyframes sleeping {
                        0%, 100% { transform: rotate(0); }
                        25% { transform: rotate(8deg); }
                        75% { transform: rotate(-8deg); }
                    }
                    
                    .empty-state {
                        text-align: center;
                        padding: 40px 20px;
                        color: #666;
                    }
                    
                    .empty-icon {
                        font-size: 3.5rem;
                        margin-bottom: 20px;
                        opacity: 0.5;
                    }
                    
                    .user-greeting {
                        font-size: 0.95rem;
                        opacity: 0.9;
                        margin-top: 10px;
                    }
                    
                    /* –§–∏–∫—Å—ã –¥–ª—è Safari */
                    input[type="checkbox"] {
                        -webkit-appearance: none;
                        appearance: none;
                        width: 22px;
                        height: 22px;
                        border-radius: 6px;
                        border: 2px solid #ccc;
                        background: white;
                        position: relative;
                        cursor: pointer;
                    }
                    
                    input[type="checkbox"]:checked {
                        background: var(--vk-blue);
                        border-color: var(--vk-blue);
                    }
                    
                    input[type="checkbox"]:checked::after {
                        content: '';
                        position: absolute;
                        left: 5px;
                        top: 1px;
                        width: 6px;
                        height: 12px;
                        border: solid white;
                        border-width: 0 2px 2px 0;
                        transform: rotate(45deg);
                    }
                    
                    .dark-mode input[type="checkbox"] {
                        background: var(--box-dark);
                        border-color: #666;
                    }
                    
                    .dark-mode input[type="checkbox"]:checked {
                        background: var(--vk-blue);
                        border-color: var(--vk-blue);
                    }
                    
                    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
                    @media (max-width: 600px) {
                        #app {
                            padding: 0 0 70px;
                        }
                        
                        .app-box {
                            margin: 10px;
                            padding: 16px;
                        }
                        
                        .todo-form {
                            flex-direction: column;
                            gap: 12px;
                        }
                        
                        .add-button {
                            padding: 14px;
                        }
                        
                        .assistant-container {
                            bottom: 20px;
                            right: 15px;
                        }
                        
                        .cat-assistant {
                            width: 70px;
                            height: 70px;
                            font-size: 45px;
                        }
                        
                        .app-footer {
                            padding: 15px;
                            margin: 0 10px;
                        }
                        
                        .header {
                            flex-wrap: wrap;
                        }
                        
                        .app-title {
                            font-size: 1.4rem;
                        }
                        
                        .todo-input, .category-select, .add-button {
                            padding: 16px;
                            font-size: 1.05rem;
                        }
                        
                        .todo-item {
                            padding: 18px 15px;
                        }
                        
                        .todo-checkbox {
                            width: 26px;
                            height: 26px;
                        }
                        
                        .remove-button {
                            width: 42px;
                            height: 42px;
                            font-size: 1.8rem;
                        }
                        
                        input, textarea, select, button {
                            -webkit-appearance: none;
                            border-radius: 10px;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // 5. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å DOM
            function getDomElement(id) {
                if (!domCache[id]) {
                    domCache[id] = document.getElementById(id);
                }
                return domCache[id];
            }

            // 6. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK
            async function initVKApp() {
                try {
                    const vkBridge = await window.vkBridgePromise;
                    await vkBridge.send('VKWebAppInit');
                    
                    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    try {
                        const user = await vkBridge.send('VKWebAppGetUserInfo');
                        state.vkUser = user;
                    } catch (e) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ');
                    }
                    
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ VK Storage
                    try {
                        const storageData = await vkBridge.send('VKWebAppStorageGet', {
                            keys: ['lifeLevelerState']
                        });
                        
                        if (storageData.keys?.[0]?.value) {
                            const savedState = JSON.parse(storageData.keys[0].value);
                            Object.assign(state, savedState);
                            saveStateToLocalStorage();
                        }
                    } catch (e) {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');
                    }
                    
                    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    setTimeout(() => {
                        showAssistantMessage(state.vkUser ? 'vkWelcome' : 'welcome');
                    }, 1000);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ VK Bridge:', error);
                }
            }

            // 7. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            function saveStateToLocalStorage() {
                localStorage.setItem('todos', JSON.stringify(state.todos));
                localStorage.setItem('darkMode', state.darkMode);
                localStorage.setItem('currentCategory', state.currentCategory);
                localStorage.setItem('completedToday', state.completedToday);
                localStorage.setItem('streak', state.streak);
                localStorage.setItem('lastCompletedDate', state.lastCompletedDate);
            }

            // 8. –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á
            function renderTodos() {
                const container = getDomElement('todos-container');
                container.innerHTML = '';
                
                const filteredTodos = state.currentCategory === 'all'
                    ? state.todos
                    : state.todos.filter(t => t.category === state.currentCategory);
                
                if (filteredTodos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìù</div>
                            <div>${state.todos.length === 0 
                                ? '–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!' 
                                : '–ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</div>
                            ${state.vkUser ? `<div class="user-greeting">–ü—Ä–∏–≤–µ—Ç, ${state.vkUser.first_name}!</div>` : ''}
                        </div>
                    `;
                    return;
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º DocumentFragment –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                const fragment = document.createDocumentFragment();
                filteredTodos.forEach(todo => {
                    fragment.appendChild(createTodoElement(todo));
                });
                container.appendChild(fragment);
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (addTask, toggleTask, –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏,
            // –Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å DOM –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            function initApp() {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
                loadNonCriticalStyles();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
                setupEventDelegation();
                
                // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
                renderCategories();
                renderTodos();
                updateUI();
                checkNewDay();
                
                // –ó–∞–ø—É—Å–∫ VK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ñ–æ–Ω–µ
                initVKApp().then(() => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ VK
                    renderTodos();
                    updateUI();
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    getDomElement('loading-screen').style.opacity = '0';
                    setTimeout(() => {
                        getDomElement('loading-screen').style.display = 'none';
                    }, 500);
                }, 300);
            }

            // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            document.addEventListener('DOMContentLoaded', initApp);
        })();

        // 9. –ò–Ω–ª–∞–π–Ω–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
        const ASSISTANT_MESSAGES = {
            welcome: { text: '–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫-–∫–æ—Ç–∏–∫!', emoji: 'üê±' },
            taskAdded: { text: '–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ! –ù–µ –∑–∞–±—É–¥—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É.', emoji: 'üìù' },
            taskCompleted: { text: '–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.', emoji: 'üéâ' },
            dailyGoalComplete: { text: '–ü–æ—Ç—Ä—è—Å–∞—é—â–µ! –¢—ã –≤—ã–ø–æ–ª–Ω–∏–ª –¥–Ω–µ–≤–Ω—É—é —Ü–µ–ª—å!', emoji: 'üèÜ' },
            allCompleted: { text: '–í–∞—É! –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –¢—ã —Å—É–ø–µ—Ä–≥–µ—Ä–æ–π!', emoji: 'ü¶∏' },
            newDay: { text: '–ù–æ–≤—ã–π –¥–µ–Ω—å - –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—à–µ–Ω–∏—è! –£ —Ç–µ–±—è –≤—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è!', emoji: 'üåû' },
            clearCompleted: { text: '–û—Ç–ª–∏—á–Ω–æ! –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –æ—á–∏—â–µ–Ω—ã.', emoji: 'üßπ' },
            vkWelcome: { text: '–ü—Ä–∏–≤–µ—Ç! –†–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏!', emoji: 'üëã' }
        };

        function renderCategories() {
            const container = document.getElementById('categories-filter');
            container.innerHTML = '';
            
            const allButton = document.createElement('button');
            allButton.className = `category-button ${state.currentCategory === 'all' ? 'active' : ''}`;
            allButton.textContent = '–í—Å–µ';
            allButton.onclick = () => {
                state.currentCategory = 'all';
                saveStateToLocalStorage();
                renderTodos();
            };
            container.appendChild(allButton);
            
            CATEGORIES.forEach(category => {
                const button = document.createElement('button');
                button.className = `category-button ${state.currentCategory === category.id ? 'active' : ''}`;
                button.textContent = category.name;
                button.style.backgroundColor = category.color;
                button.onclick = () => {
                    state.currentCategory = category.id;
                    saveStateToLocalStorage();
                    renderTodos();
                };
                container.appendChild(button);
            });
            
            const select = document.getElementById('category-select');
            select.innerHTML = '';
            CATEGORIES.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                option.style.backgroundColor = `${category.color}20`;
                select.appendChild(option);
            });
        }

        function updateUI() {
            const progressPercent = (state.completedToday / DAILY_GOAL) * 100;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            document.getElementById('progress-label').textContent = `–î–µ–Ω—å: ${state.completedToday}/${DAILY_GOAL}`;
            document.getElementById('completed-today').textContent = state.completedToday;
            document.getElementById('streak-count').textContent = state.streak;
            
            const completedCount = state.todos.filter(t => t.completed).length;
            const totalCount = state.todos.length;
            
            if (totalCount === 0) {
                document.getElementById('summary-text').textContent = '–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!';
                document.getElementById('clear-button').style.display = 'none';
            } else {
                document.getElementById('summary-text').textContent = 
                    completedCount === totalCount
                        ? `–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚ú®`
                        : `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${completedCount} –∏–∑ ${totalCount}`;
                document.getElementById('clear-button').style.display = completedCount > 0 ? 'block' : 'none';
            }
            
            document.body.classList.toggle('dark-mode', state.darkMode);
            document.getElementById('theme-toggle').textContent = state.darkMode ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            updateUI();
            saveStateToLocalStorage();
        }

        function addTask(e) {
            e.preventDefault();
            const taskInput = document.getElementById('task-input');
            const taskText = taskInput.value.trim();
            const category = document.getElementById('category-select').value;
            
            if (taskText) {
                state.todos.push({
                    id: Date.now(),
                    task: taskText,
                    completed: false,
                    category: category,
                    createdAt: new Date().toISOString()
                });
                
                saveStateToLocalStorage();
                renderTodos();
                updateUI();
                
                taskInput.value = '';
                taskInput.focus();
            }
        }

        function toggleTask(id) {
            const task = state.todos.find(t => t.id === id);
            if (!task) return;
            
            const wasCompleted = task.completed;
            task.completed = !task.completed;
            
            if (!wasCompleted) {
                state.completedToday++;
                if (state.completedToday === DAILY_GOAL) {
                    state.streak++;
                    document.getElementById('cat-assistant').classList.add('celebrating');
                    setTimeout(() => {
                        document.getElementById('cat-assistant').classList.remove('celebrating');
                    }, 3000);
                }
            } else {
                state.completedToday = Math.max(0, state.completedToday - 1);
            }
            
            state.lastCompletedDate = new Date().toDateString();
            
            saveStateToLocalStorage();
            renderTodos();
            updateUI();
        }

        function removeTask(id) {
            state.todos = state.todos.filter(t => t.id !== id);
            saveStateToLocalStorage();
            renderTodos();
            updateUI();
        }

        function clearCompleted() {
            state.todos = state.todos.filter(t => !t.completed);
            saveStateToLocalStorage();
            renderTodos();
            updateUI();
        }

        function showAssistantMessage(type) {
            const message = ASSISTANT_MESSAGES[type] || ASSISTANT_MESSAGES.welcome;
            const assistantText = document.getElementById('assistant-text');
            const assistantMessage = document.getElementById('assistant-message');
            
            assistantText.innerHTML = `<span class="emoji">${message.emoji}</span> ${message.text}`;
            assistantMessage.style.display = 'block';
            
            setTimeout(() => {
                assistantMessage.style.display = 'none';
            }, 3000);
        }

        function checkNewDay() {
            const today = new Date().toDateString();
            if (state.lastCompletedDate !== today) {
                if (state.lastCompletedDate && state.completedToday > 0) {
                    const lastDate = new Date(state.lastCompletedDate);
                    const todayDate = new Date();
                    const diffDays = Math.ceil(Math.abs(todayDate - lastDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 1) {
                        state.streak = 0;
                    }
                }
                
                state.completedToday = 0;
                state.lastCompletedDate = today;
                saveStateToLocalStorage();
                updateUI();
            }
        }
    </script>
</body>
</html>
